name: Release Plugin

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Build plugin
      run: |
        cd Server
        dotnet publish -c Release -o ../output

    - name: Create plugin package
      run: |
        # Get version from tag (remove 'v' prefix)
        VERSION=${GITHUB_REF_NAME#v}
        echo "VERSION=$VERSION" >> $GITHUB_ENV

        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV

        # Create meta.json for Jellyfin plugin system
        cat > output/meta.json << METAEOF
        {
          "guid": "7f4a3b2c-6d5e-4a11-9c2b-5e3a7d4f8a21",
          "name": "ClipShare",
          "description": "Create video clips from the Jellyfin player",
          "overview": "Create video clips directly from the Jellyfin video player.",
          "owner": "jeantou666",
          "category": "General",
          "targetAbi": "10.11.0.0",
          "sourceUrl": "https://github.com/jeantou666/jellyfin-plugin-clipshare",
          "version": "${VERSION}",
          "timestamp": "${TIMESTAMP}",
          "assemblies": ["ClipShare.dll"],
          "status": "Active",
          "autoUpdate": true
        }
        METAEOF

        # List contents for debugging
        echo "=== Package contents ==="
        ls -la output/
        echo "=== meta.json ==="
        cat output/meta.json

        # Create zip file with all contents in root
        cd output
        zip -r ../clipshare.zip .
        cd ..

        # Calculate MD5 checksum
        CHECKSUM=$(md5sum clipshare.zip | awk '{print $1}' | tr '[:lower:]' '[:upper:]')
        echo "CHECKSUM=$CHECKSUM" >> $GITHUB_ENV

        echo "=== Build Summary ==="
        echo "Version: $VERSION"
        echo "Checksum: $CHECKSUM"
        echo "Timestamp: $TIMESTAMP"

    - name: Update manifest.json
      run: |
        # Create new version entry
        NEW_VERSION=$(cat <<EOF
        {
          "version": "${{ env.VERSION }}",
          "changelog": "Auto build",
          "targetAbi": "10.11.0.0",
          "sourceUrl": "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/clipshare.zip",
          "checksum": "${{ env.CHECKSUM }}",
          "timestamp": "${{ env.TIMESTAMP }}"
        }
        EOF
        )

        # Update manifest.json using jq - keep only latest 3 versions
        jq --argjson new "$NEW_VERSION" '
          .[0].versions = ([$new] + .[0].versions) | .[0:3]
        ' repository/manifest.json > manifest_temp.json && mv manifest_temp.json repository/manifest.json

        echo "=== Updated manifest.json ==="
        cat repository/manifest.json

    - name: Commit and push updated manifest
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add repository/manifest.json
        git commit -m "Update manifest for v${{ env.VERSION }}" || echo "No changes to commit"
        git push origin main

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: clipshare.zip
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
