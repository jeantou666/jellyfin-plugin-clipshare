name: Build & Publish Jellyfin Plugin

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # ---------------- CHECKOUT ----------------
    - name: Checkout (with submodules)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive

    - name: Restore Jellyfin submodules
      run: git submodule update --init --recursive

    # ---------------- DOTNET ----------------
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # ---------------- BUILD SERVER ----------------
    - name: Publish plugin
      run: dotnet publish Server/ClipShare.csproj -c Release -o publish

    # ---------------- PACKAGE SERVER ----------------
    - name: Create server package
      run: |
        mkdir serverpkg
        cp -r publish/* serverpkg/
        cd serverpkg
        zip -r ../clipshare-server.zip .

    # ---------------- PACKAGE WEB ----------------
    - name: Create web package
      run: |
        mkdir webpkg
        cp -r Web/* webpkg/
        cd webpkg
        zip -r ../clipshare-web.zip .

    # ---------------- CHECKSUM ----------------
    - name: Compute checksums
      id: checksum
      run: |
        SERVER_SHA=$(sha256sum clipshare-server.zip | cut -d ' ' -f1)
        WEB_SHA=$(sha256sum clipshare-web.zip | cut -d ' ' -f1)

        echo "server=$SERVER_SHA" >> $GITHUB_OUTPUT
        echo "web=$WEB_SHA" >> $GITHUB_OUTPUT

    # ---------------- RELEASE ----------------
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          clipshare-server.zip
          clipshare-web.zip

    # ---------------- SWITCH TO MAIN ----------------
    - name: Switch to main branch
      run: |
        git fetch origin main
        git checkout main
        git pull origin main

    # ---------------- UPDATE MANIFEST ----------------
    - name: Update repository manifest
      run: |
        VERSION=${GITHUB_REF_NAME#v}
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

        SERVER_URL="https://github.com/${{ github.repository }}/releases/download/${GITHUB_REF_NAME}/clipshare-server.zip"
        WEB_URL="https://github.com/${{ github.repository }}/releases/download/${GITHUB_REF_NAME}/clipshare-web.zip"

        SERVER_SHA="${{ steps.checksum.outputs.server }}"
        WEB_SHA="${{ steps.checksum.outputs.web }}"

        tmp=$(mktemp)

        jq --arg version "$VERSION" \
           --arg ts "$TIMESTAMP" \
           --arg s_url "$SERVER_URL" \
           --arg s_sha "$SERVER_SHA" \
           --arg w_url "$WEB_URL" \
           --arg w_sha "$WEB_SHA" \
           '
           .[0].versions |=
           ([{
              version: $version,
              changelog: "Auto build",
              targetAbi: "10.11.0.0",
              sourceUrl: $s_url,
              checksum: $s_sha,
              timestamp: $ts
           }] + .)
           ' repository/manifest.json > "$tmp"

        mv "$tmp" repository/manifest.json

    # ---------------- COMMIT ----------------
    - name: Commit manifest
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add repository/manifest.json
        git commit -m "Add version v${GITHUB_REF_NAME#v}" || echo "No change"
        git push origin main
