name: Build & Publish Jellyfin Plugin

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # ---------------- CHECKOUT ----------------
    - name: Checkout (with submodules)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive

    - name: Ensure submodules
      run: git submodule update --init --recursive

    # ---------------- DOTNET ----------------
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # ---------------- BUILD SERVER ----------------
    - name: Publish plugin
      run: dotnet publish Server/ClipShare.csproj -c Release -o publish

    # ---------------- PACKAGE SERVER ----------------
    - name: Create server package
      run: |
        mkdir serverpkg
        cp -r publish/* serverpkg/
        cd serverpkg
        zip -r ../clipshare-server.zip .

    # ---------------- PACKAGE WEB ----------------
    - name: Create web package
      run: |
        mkdir webpkg
        cp -r Web/* webpkg/
        cd webpkg
        zip -r ../clipshare-web.zip .

    # ---------------- CREATE RELEASE ----------------
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          clipshare-server.zip
          clipshare-web.zip

    - name: Wait GitHub CDN
      run: sleep 20

    - name: Get real asset URLs + checksum
      run: |
        VERSION=${GITHUB_REF_NAME}
    
        API="https://api.github.com/repos/${{ github.repository }}/releases/tags/${VERSION}"
        curl -s $API > release.json
    
        SERVER_URL=$(jq -r '.assets[] | select(.name=="clipshare-server.zip") | .browser_download_url' release.json)
        WEB_URL=$(jq -r '.assets[] | select(.name=="clipshare-web.zip") | .browser_download_url' release.json)
    
        echo "SERVER_URL=$SERVER_URL" >> $GITHUB_ENV
        echo "WEB_URL=$WEB_URL" >> $GITHUB_ENV
    
        curl -L -o server.zip "$SERVER_URL"
        curl -L -o web.zip "$WEB_URL"
    
        sha256sum server.zip | cut -d ' ' -f1 > server.sha
        sha256sum web.zip | cut -d ' ' -f1 > web.sha



    # ---------------- SWITCH TO MAIN ----------------
    - name: Switch to main branch
      run: |
        git fetch origin main
        git checkout main
        git pull origin main

    # ---------------- UPDATE MANIFEST ----------------
    - name: Update repository manifest
      run: |
        SERVER_SHA=$(cat server.sha)
        WEB_SHA=$(cat web.sha)

        VERSION=${GITHUB_REF_NAME#v}
        URL_SERVER="$SERVER_URL"
        URL_WEB="$WEB_URL"

        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

        tmp=$(mktemp)

        jq \
          --arg version "$VERSION" \
          --arg url_server "$URL_SERVER" \
          --arg url_web "$URL_WEB" \
          --arg ts "$TIMESTAMP" \
          --arg server_sha "$SERVER_SHA" \
          --arg web_sha "$WEB_SHA" \
        '
        .[0].versions |=
        ([{
          version: $version,
          changelog: "Auto build",
          targetAbi: "10.11.0.0",
          sourceUrl: $url_server,
          checksum: $server_sha,
          timestamp: $ts
        }] + .)
        |
        .[1].versions |=
        ([{
          version: $version,
          changelog: "Auto build",
          targetAbi: "10.11.0.0",
          sourceUrl: $url_web,
          checksum: $web_sha,
          timestamp: $ts
        }] + .)
        ' repository/manifest.json > "$tmp"

        mv "$tmp" repository/manifest.json


    # ---------------- COMMIT ----------------
    - name: Commit manifest
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add repository/manifest.json
        git commit -m "Add version v${GITHUB_REF_NAME#v}" || echo "No change"
        git push origin main
